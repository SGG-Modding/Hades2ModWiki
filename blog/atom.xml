<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://sgg-modding.github.io/Hades2ModWiki/blog</id>
    <title>Hades 2 Mod Wiki Blog</title>
    <updated>2024-07-02T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://sgg-modding.github.io/Hades2ModWiki/blog"/>
    <subtitle>Hades 2 Mod Wiki Blog</subtitle>
    <icon>https://sgg-modding.github.io/Hades2ModWiki/img/Pom.png</icon>
    <entry>
        <title type="html"><![CDATA[Multithreaded modding]]></title>
        <id>https://sgg-modding.github.io/Hades2ModWiki/blog/multithreading</id>
        <link href="https://sgg-modding.github.io/Hades2ModWiki/blog/multithreading"/>
        <updated>2024-07-02T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Any fun game has to deal with multiple jobs at the same time to provide a good experience. Hades 2 in particular plays Music and sound effects, moves enemies, reacts to the player's input, renders the beautiful scenery, manages game and run state and so on and so forth. For all this to work at the same time, the script and the engine run many functions in parallel. For example, the AI for every enemy gets its own thread to execute in.]]></summary>
        <content type="html"><![CDATA[<p>Any fun game has to deal with multiple jobs at the same time to provide a good experience. Hades 2 in particular plays Music and sound effects, moves enemies, reacts to the player's input, renders the beautiful scenery, manages game and run state and so on and so forth. For all this to work at the same time, the script and the engine run many functions in parallel. For example, the AI for every enemy gets its own thread to execute in.</p>
<p>On the lua scripting side of things (we don't know much about the engine) this is achieved using lua's built in coroutines. The difference between these coroutines and "real" multithreading is meaningful, but since it is neither relevant to this post's main point nor am I an expert on the topic I will just reference the lua docs on <a href="https://www.lua.org/pil/9.4.html" target="_blank" rel="noopener noreferrer">coroutines vs. threads</a>. Also, I will continue to call the asynchronous workers threads, because Supergiant Games chooses this name aswell in their <code>Main.lua</code> script.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="waiting-and-resuming">Waiting and resuming<a class="hash-link" aria-label="Direct link to Waiting and resuming" title="Direct link to Waiting and resuming" href="https://sgg-modding.github.io/Hades2ModWiki/blog/multithreading#waiting-and-resuming">​</a></h2>
<p>Sometimes one of these threads has to wait for something to happen in another thread. This is where the capability for any thread to yield execution while the thing hasn't happened comes in handy. For example, some enemies stand still while the player character is not in range. The enemy AI thread just tells the program to give execution time to other threads until the player character is in range for the AI to start doing something.</p>
<p>Supergiant provides some very useful helper methods to manage these kinds of behaviours in their <code>Main.lua</code> script. In particular, the method <code>waitUntil()</code> is used to yield until a certain condition is met. When you do a quick search through the codebase, you will find many examples of this (not only the one I picked out for this post).</p>
<p><img decoding="async" loading="lazy" alt="image" src="https://sgg-modding.github.io/Hades2ModWiki/assets/images/waitUntilSearch-7b5d248d78f27f2a568e433bcd1ba758.png" width="1035" height="726" class="img_ev3q"></p>
<p>While looking at a few examples, you will notice that every call of this function has to provide some kind of special string. This string is the name of the signal that the thread is waiting for.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="signal-based-processing">Signal based processing<a class="hash-link" aria-label="Direct link to Signal based processing" title="Direct link to Signal based processing" href="https://sgg-modding.github.io/Hades2ModWiki/blog/multithreading#signal-based-processing">​</a></h2>
<p>Signals are one method to handle reacting to things that happen. Many of you will also be familiar with events as a similar concept. The main difference here is that events are processed synchronously via callbacks and signals are processed asynchronously (for example by using different threads).</p>
<p>While some signals in Hades 2 are triggered by the engine, the game also has lua functions for triggering signals, namely <code>notify()</code> and <code>notifyExistingWaiters()</code> both in "Main.lua", which are used extensively (especially the latter). The first function registers that something, that can only happen once, has happened. This resumes all threads waiting for the signal and saves the information that this signal has been fired, so that future threads waiting for the signal can be resumed immediately. Despite this useful feature this function is used only very rarely throughout the scripts (and those uses are probably missed code updates, but I am not sure about this). The other function only continues currently waiting threads that a thing happened, which can happen multiple times.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="but-why-should-i-care">But why should I care?<a class="hash-link" aria-label="Direct link to But why should I care?" title="Direct link to But why should I care?" href="https://sgg-modding.github.io/Hades2ModWiki/blog/multithreading#but-why-should-i-care">​</a></h2>
<p>Many modding tasks can be achieved by starting threads that wait for a certain signal. As an example, I will show you how to build a simple mod that prints a stoic quote every time a boon is obtained. To do this, I obtained quotes in a JSON file from <a href="https://gist.github.com/miharekar/d57b58b017c457cd18062a1c36d82e02" target="_blank" rel="noopener noreferrer">here</a> and transformed them into a lua table with this quick and dirty python script:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="background-color:#282c34;color:#ffffff"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token keyword" style="color:#c5a5c5">import</span><span class="token plain"> json</span><span class="token punctuation" style="color:#8dc891">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">f </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token builtin" style="color:#D8DEE9">open</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string" style="color:#8dc891">"quotes.json"</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">'r'</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> encoding</span><span class="token operator" style="color:#d7deea">=</span><span class="token string" style="color:#8dc891">"UTF-8"</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">content </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> f</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">read</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">f</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">close</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">data </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> json</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">loads</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">content</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">quoteArray </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:#8dc891">[</span><span class="token string" style="color:#8dc891">"quotes"</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">f </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token builtin" style="color:#D8DEE9">open</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string" style="color:#8dc891">"quotes.lua"</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">"w"</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> encoding</span><span class="token operator" style="color:#d7deea">=</span><span class="token string" style="color:#8dc891">"UTF-8"</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">f</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">write</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string" style="color:#8dc891">"StoicQuotes = {\n"</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#c5a5c5">in</span><span class="token plain"> </span><span class="token builtin" style="color:#D8DEE9">range</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token builtin" style="color:#D8DEE9">len</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">quoteArray</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    pivot </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> quoteArray</span><span class="token punctuation" style="color:#8dc891">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    text </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token builtin" style="color:#D8DEE9">str</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">pivot</span><span class="token punctuation" style="color:#8dc891">[</span><span class="token string" style="color:#8dc891">"text"</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">"\""</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">"\\\""</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    author </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token builtin" style="color:#D8DEE9">str</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">pivot</span><span class="token punctuation" style="color:#8dc891">[</span><span class="token string" style="color:#8dc891">"author"</span><span class="token punctuation" style="color:#8dc891">]</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">"\""</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">"\\\""</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    f</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">write</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string-interpolation string" style="color:#8dc891">f"    {{\n        Quote = \042</span><span class="token string-interpolation interpolation punctuation" style="color:#8dc891">{</span><span class="token string-interpolation interpolation">text</span><span class="token string-interpolation interpolation punctuation" style="color:#8dc891">}</span><span class="token string-interpolation string" style="color:#8dc891">\042,\n        Author = \042</span><span class="token string-interpolation interpolation punctuation" style="color:#8dc891">{</span><span class="token string-interpolation interpolation">author</span><span class="token string-interpolation interpolation punctuation" style="color:#8dc891">}</span><span class="token string-interpolation string" style="color:#8dc891">\042\n    }},\n"</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">f</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">write</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string" style="color:#8dc891">"}"</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">f</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">close</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="building-a-little-example-mod">Building a little example mod<a class="hash-link" aria-label="Direct link to Building a little example mod" title="Direct link to Building a little example mod" href="https://sgg-modding.github.io/Hades2ModWiki/blog/multithreading#building-a-little-example-mod">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="setting-up">Setting up<a class="hash-link" aria-label="Direct link to Setting up" title="Direct link to Setting up" href="https://sgg-modding.github.io/Hades2ModWiki/blog/multithreading#setting-up">​</a></h3>
<p>For this mod I use the <a href="https://github.com/SGG-Modding/Hades2ModTemplate" target="_blank" rel="noopener noreferrer">Hades 2 Mod Template</a>. After cloning (or downloading), we just make one little adjustment. We want every global (or mod-local) variable to be PascalCased. For example, line 28 in <code>main.lua</code> becomes <code>ModUtil = mods['SGG_Modding-ModUtil']</code> instead of <code>modutil = mods['SGG_Modding-ModUtil']</code>. Now the <code>quotes.lua</code> file has to be copied into the <code>src/</code> folder of the mod. After that, the quotes can be imported in <code>main.lua</code> like this:</p>
<p><strong><code>main.lua</code></strong></p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:#282c34;color:#ffffff"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token punctuation" style="color:#8dc891">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">local</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">on_ready</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token comment" style="color:#999999">-- what to do when we are ready, but not re-do on reload.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    </span><span class="token keyword" style="color:#c5a5c5">if</span><span class="token plain"> Config</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">Enabled </span><span class="token operator" style="color:#d7deea">==</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">false</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">then</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">return</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    import </span><span class="token string" style="color:#8dc891">'ready.lua'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">    import </span><span class="token string" style="color:#8dc891">'quotes.lua'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hooking-into-the-reward-spawning">Hooking into the reward spawning<a class="hash-link" aria-label="Direct link to Hooking into the reward spawning" title="Direct link to Hooking into the reward spawning" href="https://sgg-modding.github.io/Hades2ModWiki/blog/multithreading#hooking-into-the-reward-spawning">​</a></h3>
<p>Next, we need to know when a reward gets spawned, so that we can start listening to the signal indicating that the boon choice is finished. After a bit of searching, I found the function <code>SpawnRoomReward()</code> in <code>RewardLogic.lua</code>. This function creates the reward and returns it. Thus, we can get access to the properties of the reward. One of these properties indicates whether the reward is associated with a menu to choose upgrade options from. If it is, the menu will fire a signal when it is closed and the choice has benn made. This is exactly when we want to display our quotes.</p>
<p>We set up the hook like this:</p>
<p><strong><code>ready.lua</code></strong></p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:#282c34;color:#ffffff"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token comment" style="color:#999999">---@meta _</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999">-- globals we define are private to our plugin!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999">---@diagnostic disable: lowercase-global</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999">-- here is where your mod sets up all the things it will do.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999">-- this file will not be reloaded if it changes during gameplay</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999">-- 	so you will most likely want to have it reference</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token comment" style="color:#999999">--	values and functions later defined in `reload.lua`.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">ModUtil</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">mod</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">Path</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token function" style="color:#79b6f2">Wrap</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string" style="color:#8dc891">"SpawnRoomReward"</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">base</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> event</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> source</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token keyword" style="color:#c5a5c5">return</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">patch_SpawnRoomReward</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">base</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> event</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> source</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">end</span><span class="token punctuation" style="color:#8dc891">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We implement the function like this:</p>
<p><strong><code>reload.lua</code></strong></p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:#282c34;color:#ffffff"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">patch_SpawnRoomReward</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">base</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> event</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> source</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token keyword" style="color:#c5a5c5">local</span><span class="token plain"> reward </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">base</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> source</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token keyword" style="color:#c5a5c5">if</span><span class="token plain"> reward </span><span class="token operator" style="color:#d7deea">~=</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">nil</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">and</span><span class="token plain"> reward</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">MenuNotify </span><span class="token operator" style="color:#d7deea">~=</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">nil</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">		</span><span class="token function" style="color:#79b6f2">thread</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">waitingPrinter</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> Game</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">UIData</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">BoonMenuId</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token keyword" style="color:#c5a5c5">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token keyword" style="color:#c5a5c5">return</span><span class="token plain"> reward</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">waitingPrinter</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">signalName</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token function" style="color:#79b6f2">waitUntil</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">signalName</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now we spawn a thread every time a reward with an associated boon menu is spawned. This thread waits for the close signal of the menu but does not do anything after that. We change that in the next step.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="displaying-a-random-quote">Displaying a random quote<a class="hash-link" aria-label="Direct link to Displaying a random quote" title="Direct link to Displaying a random quote" href="https://sgg-modding.github.io/Hades2ModWiki/blog/multithreading#displaying-a-random-quote">​</a></h3>
<p>There is a useful function for displaying text near a unit named <code>InCombatText()</code> which can be found in <code>CombatPresentation.lua</code>. This function needs the object ID of a unit, some text to display and a display duration. We choose a random quote and build a string to display from it (pasting newlines at some places to prevent text overflow), take the object ID from the <code>Hero</code> object and display the quote for 15 seconds.</p>
<p><strong><code>reload.lua</code></strong></p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:#282c34;color:#ffffff"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token punctuation" style="color:#8dc891">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">waitingPrinter</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">signalName</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token function" style="color:#79b6f2">waitUntil</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">signalName</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token keyword" style="color:#c5a5c5">local</span><span class="token plain"> quote </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">GetRandomValue</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">StoicQuotes</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token keyword" style="color:#c5a5c5">local</span><span class="token plain"> spaceChars </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token keyword" style="color:#c5a5c5">local</span><span class="token plain"> quoteText </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> quote</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">Quote</span><span class="token punctuation" style="color:#8dc891">:</span><span class="token function" style="color:#79b6f2">gsub</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string" style="color:#8dc891">"%s"</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">		spaceChars </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> spaceChars </span><span class="token operator" style="color:#d7deea">+</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">		</span><span class="token keyword" style="color:#c5a5c5">if</span><span class="token plain"> spaceChars </span><span class="token operator" style="color:#d7deea">==</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">10</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">			spaceChars </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">			</span><span class="token keyword" style="color:#c5a5c5">return</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">"\n"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">		</span><span class="token keyword" style="color:#c5a5c5">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">		</span><span class="token keyword" style="color:#c5a5c5">return</span><span class="token plain"> c</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token keyword" style="color:#c5a5c5">end</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token keyword" style="color:#c5a5c5">local</span><span class="token plain"> toPrint </span><span class="token operator" style="color:#d7deea">=</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">"\""</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">..</span><span class="token plain"> quoteText </span><span class="token operator" style="color:#d7deea">..</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">"\" - "</span><span class="token plain"> </span><span class="token operator" style="color:#d7deea">..</span><span class="token plain"> quote</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">Author</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token function" style="color:#79b6f2">InCombatText</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">Game</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">CurrentRun</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">Hero</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">ObjectId</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> toPrint</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token number" style="color:#5a9bcf">15</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tagging-threads-for-easy-deletion">Tagging threads for easy deletion<a class="hash-link" aria-label="Direct link to Tagging threads for easy deletion" title="Direct link to Tagging threads for easy deletion" href="https://sgg-modding.github.io/Hades2ModWiki/blog/multithreading#tagging-threads-for-easy-deletion">​</a></h3>
<p>Since all threads are saved in a table in the <code>Main.lua</code> script of the game, we should clean up the threads that didn't trigger when they can't trigger anymore. In this example a quote cannot be printed anymore when the room is left without (for whatever reason) picking up the boon. There is built-in functionality for this once again with the function <code>killTaggedThreads()</code> in <code>Main.lua</code>.</p>
<p>Every thread that calls <code>waitUntil()</code> can provide an optional tag name as the second argument. This way, the thread can be killed via calling <code>killTaggedThreads()</code> at any point with the chosen tag name. We can use this in a hook for the <code>LeaveRoom()</code> function from <code>RoomLogic.lua</code> to dispose of the threads that didn't trigger.</p>
<p>Setting the additional hook:</p>
<p><strong><code>ready.lua</code></strong></p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:#282c34;color:#ffffff"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token punctuation" style="color:#8dc891">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">ModUtil</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">mod</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token plain">Path</span><span class="token punctuation" style="color:#8dc891">.</span><span class="token function" style="color:#79b6f2">Wrap</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string" style="color:#8dc891">"LeaveRoom"</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">base</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> currentRun</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> door</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token keyword" style="color:#c5a5c5">return</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">patch_LeaveRoom</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">base</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> currentRun</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> door</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">end</span><span class="token punctuation" style="color:#8dc891">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Implementing tag name and desctruction:</p>
<p><strong><code>reload.lua</code></strong></p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:#282c34;color:#ffffff"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token punctuation" style="color:#8dc891">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">waitingPrinter</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">signalName</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token function" style="color:#79b6f2">waitUntil</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">signalName</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">"Siuhnexus-StoicQuotes-QuotePrinter"</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token punctuation" style="color:#8dc891">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">patch_LeaveRoom</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">base</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> currentRun</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> door</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token function" style="color:#79b6f2">killTaggedThreads</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string" style="color:#8dc891">"Siuhnexus-StoicQuotes-QuotePrinter"</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token function" style="color:#79b6f2">base</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">currentRun</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> door</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Since every tag name has to play nice with the game tags and other mods, it is best practice to prefix every custom tag with your creator name and your mod name. You can write a convenience function in larger projects like this:</p>
<p><strong><code>reload.lua</code></strong></p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:#282c34;color:#ffffff"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">prefixTag</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">tagName</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token keyword" style="color:#c5a5c5">return</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">"Siuhnexus-StoicQuotes-"</span><span class="token operator" style="color:#d7deea">..</span><span class="token plain">tagName</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">waitingPrinter</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">signalName</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token function" style="color:#79b6f2">waitUntil</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">signalName</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">prefixTag</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string" style="color:#8dc891">"QuotePrinter"</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token punctuation" style="color:#8dc891">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">patch_LeaveRoom</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">base</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> currentRun</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> door</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token function" style="color:#79b6f2">killTaggedThreads</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token function" style="color:#79b6f2">prefixTag</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string" style="color:#8dc891">"QuotePrinter"</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token function" style="color:#79b6f2">base</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">currentRun</span><span class="token punctuation" style="color:#8dc891">,</span><span class="token plain"> door</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="dispatching-custom-signals">Dispatching custom signals<a class="hash-link" aria-label="Direct link to Dispatching custom signals" title="Direct link to Dispatching custom signals" href="https://sgg-modding.github.io/Hades2ModWiki/blog/multithreading#dispatching-custom-signals">​</a></h3>
<p>With this system, you can even allow other mods to react to your quotes being printed. Just dispatch a custom signal (prefixed to play nice):</p>
<p><strong><code>reload.lua</code></strong></p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#282c34;--prism-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="background-color:#282c34;color:#ffffff"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#ffffff"><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">prefixTag</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">tagName</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token keyword" style="color:#c5a5c5">return</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">"Siuhnexus-StoicQuotes-"</span><span class="token operator" style="color:#d7deea">..</span><span class="token plain">tagName</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">prefixSignal</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">signalName</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token keyword" style="color:#c5a5c5">return</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">"Siuhnexus-StoicQuotes-"</span><span class="token operator" style="color:#d7deea">..</span><span class="token plain">signalName</span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token punctuation" style="color:#8dc891">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">function</span><span class="token plain"> </span><span class="token function" style="color:#79b6f2">waitingPrinter</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token plain">signalName</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token punctuation" style="color:#8dc891">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain">	</span><span class="token function" style="color:#79b6f2">notifyExistingWaiters</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token function" style="color:#79b6f2">prefixSignal</span><span class="token punctuation" style="color:#8dc891">(</span><span class="token string" style="color:#8dc891">"QuotePrinted"</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token punctuation" style="color:#8dc891">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#ffffff"><span class="token plain"></span><span class="token keyword" style="color:#c5a5c5">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-real-world-example">A real-world example<a class="hash-link" aria-label="Direct link to A real-world example" title="Direct link to A real-world example" href="https://sgg-modding.github.io/Hades2ModWiki/blog/multithreading#a-real-world-example">​</a></h2>
<p>The reason for me knowing about this and being very excited about it is my first little dabble into Hades 2 modding. I was looking for some fun mods and came across "MultiReward" by "abevol" on Thunderstore. This mod lets you spawn multiple copies of any room reward and lifts the maximum god restriction to let you experience what the full support of Olympus would be like. This is very fun, but the old way of spawning the boon had its limitations. Since rewards were spawned in a loop all at the same location and time, the screen was full of glow effects when spawning many boons, making it hard to see the god icon. Also, the bow in the fields of mourning pinged once for every spawned reward, which was annoying. Caged rewards could be obtained before clearing the encounter since every cage is associated with only one reward aswell.</p>
<p>This problem could be resolved by firing a custom signal in a very cautious <code>OnUsed</code> engine hook and spawning a thread in <code>SpawnRoomReward()</code> which reacted to the custom event. This spawns the rewards one after another without blocking the game logic and was exactly what I was looking for. If you are interested in the details, just check out the <a href="https://github.com/abevol/MultiReward" target="_blank" rel="noopener noreferrer">source code</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="final-notes">Final notes<a class="hash-link" aria-label="Direct link to Final notes" title="Direct link to Final notes" href="https://sgg-modding.github.io/Hades2ModWiki/blog/multithreading#final-notes">​</a></h2>
<p>Thank you for making it this far! I hope you are as excited about the potential of this concept as I am. I am looking forward to seeing what you can build with this.</p>]]></content>
        <author>
            <name>Siuhnexus</name>
            <uri>https://github.com/Siuhnexus</uri>
        </author>
        <category label="Multithreading" term="Multithreading"/>
        <category label="Signal" term="Signal"/>
        <category label="Processing" term="Processing"/>
        <category label="Asynchronous" term="Asynchronous"/>
    </entry>
</feed>